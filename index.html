<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>PiBoat</title>

    <meta name="author" content="richet">

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!--link href="css/style.css" rel="stylesheet"-->
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <script src="js/jquery.min.js" type="text/javascript"></script>
    <script src="js/bootstrap.min.js" type="text/javascript"></script>
  
    <!--script src="node_modules/ws/index.js" type="text/javascript"></script-->

  </head>
  <body>

<h1>View</h1>



    <div class="container-fluid">
	<div class="row">
		<div class="col-xs-12">
			<div class="row">
				<div class="col-xs-12">
					<div class="media well">

						 <!--div class="jsmpeg" data-url="video.ts"></div-->
						 <center><img id='view' src="http://localhost:8080/stream/video.mjpeg" alt="View" width="100%"></img></center>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-xs-4">
				</div>
				<div class="col-xs-4">
					<div class="row">
						<div class="col-xs-12">
							<center> 
							<button name="forward" id="forward" class="btn btn-default" href="" aria-label="Forward">
                              <i class="fa fa-arrow-up" aria-hidden="true"></i>
                            </button>
                            <script>
                                $('#forward').click(function(e) {
                                    e.preventDefault();
                                    $.post('/forward')
                                });
                            </script>
							</center>
						</div>
					</div>
				</div>
				<div class="col-xs-4">
				</div>
			</div>
			<br/>
			<div class="row">
				<div class="col-xs-4">
					<div class="row">
						<div class="col-xs-12">
							<center>
							<button name="left" id="left" class="btn btn-default" href="" aria-label="Left">
                              <i class="fa fa-arrow-left" aria-hidden="true"></i>
                            </button>
							<script>
                                $('#left').click(function(e) {
                                    e.preventDefault();
                                    $.post('/left')
                                });
                            </script>
                            </center>
						</div>
					</div>
				</div>
				<div class="col-xs-4">
					<div class="row">
						<div class="col-xs-12">
							<center> 
							<button name="stop" id="stop" class="btn btn-default" href="" aria-label="Stop">
                              <i class="fa fa-stop" aria-hidden="true"></i>
                            </button>
							<script>
                                $('#stop').click(function(e) {
                                    e.preventDefault();
                                    $.post('/stop')
                                });
                            </script>
                            </center>
						</div>
					</div>
				</div>
				<div class="col-xs-4">
					<div class="row">
						<div class="col-xs-12">
							<center> 
							<button name="right" id="right" class="btn btn-default" href="" aria-label="Right">
                              <i class="fa fa-arrow-right" aria-hidden="true"></i>
                            </button>
							<script>
                                $('#right').click(function(e) {
                                    e.preventDefault();
                                    $.post('/right')
                                });
                            </script>
                            </center>
						</div>
					</div>
				</div>
			</div>
			<br/>
			<div class="row">
				<div class="col-xs-4">
				</div>
				<div class="col-xs-4">
					<div class="row">
						<div class="col-xs-12">
							<center> 
							<button  name="backward" id="backward" class="btn btn-default" href="" aria-label="Backward">
                              <i class="fa fa-arrow-down" aria-hidden="true"></i>
                            </button>
							<script>
                                $('#backward').click(function(e) {
                                    e.preventDefault();
                                    $.post('/backward')
                                });
                            </script>
                            </center>
						</div>
					</div>
				</div>
				<div class="col-xs-4">
				</div>
			</div>
		</div>
	</div>
</div>

<script>    
var ip = location.host;
$("#view").attr("src", "http://"+ip+":8080/stream/video.mjpeg");
console.log("ip: "+ip);
</script>

      <h1 id="start"></h1>
      <script>
          // Setup websocket to pass controller actions to server
          //@ref: https://hackernoon.com/nodejs-web-socket-example-tutorial-send-message-connect-express-set-up-easy-step-30347a2c5535

          var ws = new WebSocket('ws://'+location.host+':3000');
          // event emmited when connected
          ws.onopen = function () {
              console.log('websocket is connected ...')
              // sending a send event to websocket server
              ws.send('connected')
          }

          // event emmited when receiving message 
          ws.onmessage = function (ev) {
              console.log(ev);
          }


window.addEventListener('gamepadconnected', (event) => {
  const update = () => {
    const output = document.getElementById('axes');
    output.innerHTML = ''; // clear the output

    for (const gamepad of navigator.getGamepads()) {
      if (!gamepad) continue;
      for (const [index, axis] of gamepad.axes.entries()) {
        output.insertAdjacentHTML('beforeend',
          `<label>${gamepad.index}, ${index}
             <progress value=${axis * 0.5 + 0.5}></progress>
           </label>`);
           console.log("index: "+index);
           console.log("gamepad.axes: "+gamepad.axes);

           var i = index;
           var speed  = 0;
           var angle = 0; 
           if (i==0) {
              if (angle != gamepad.axes[i]) {
                angle = gamepad.axes[i];
                console.log("angle: "+angle);
                 ws.send("angle: "+angle);
              }
            }
            if (i==1) { 
              if (speed != gamepad.axes[i]) {
                speed = gamepad.axes[i];
                console.log("speed: "+speed);
                ws.send("speed: "+speed);
              }
            }
      }
    }
    requestAnimationFrame(update);
  };
  update();
});

      </script>

    <div id="axes" style="display: flex; flex-direction: column;"></div>

  </body>
</html>
